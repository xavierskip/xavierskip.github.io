---
layout: post
title: å¦‚ä½•è®¾ç½®è®©å…¬ç½‘å’Œå†…ç½‘ç”¨æˆ·é€šè¿‡åŒæ ·çš„æ–¹å¼è®¿é—®ç«¯å£æ˜ å°„å‡ºå»çš„æœåŠ¡
tags:
 - network
 - NAT
 - RouterOS
---

å¦‚æœä½ æœ‰ä¸€é¡¹æœåŠ¡é€šè¿‡ç«¯å£æ˜ å°„åˆ°å…¬ç½‘ï¼Œå› ä¸ºä¸æ˜¯å›ºå®šIPé‚£ä¹ˆä¸€èˆ¬éƒ½æ˜¯é€šè¿‡åŸŸåè®¿é—®ï¼Œé‚£ä¹ˆå¦‚ä½•è®¾ç½®è®©å…¬ç½‘å’Œå†…ç½‘ä½¿ç”¨åŒæ ·çš„åŸŸååŠ ç«¯å£çš„æ–¹å¼æ¥è®¿é—®æœåŠ¡ï¼Ÿ

ç›´æ¥è¯´ç»“è®ºå§ã€‚ä¸è¦å°è¯•é€šè¿‡é…ç½®è·¯ç”±å™¨æ¥å®ç°ï¼Œè€Œæ˜¯åº”è¯¥åœ¨å†…ç½‘æ­å»ºä¸€ä¸ªdnsæœåŠ¡ï¼Œå†…ç½‘ç”¨æˆ·è¿›è¡ŒåŸŸåè§£ææ—¶ç›´æ¥è¿”å›å†…éƒ¨æœåŠ¡å™¨IPï¼Œå¤–ç½‘è®¿é—®æ­£å¸¸ä½¿ç”¨ä¸å—ä»»ä½•å½±å“ã€‚

ä¸ºä»€ä¹ˆï¼Ÿç½‘ä¸Šå„ç§è§£å†³æ–¹æ¡ˆä¸€å¤§å †ï¼Œæœ‰çš„é…ç½®å¾ˆç®€å•ï¼Œæœ‰çš„å¾ˆå¤æ‚ï¼Œç”±äºä¸æ‡‚è®¾å¤‡çš„å…·ä½“å·¥ä½œæµç¨‹å…¶å®ä¹Ÿçœ‹ä¸å¤ªæ‡‚å„ç§é…ç½®çš„å·¥ä½œåŸç†ï¼Œä¸€ä¸ªä¸ªå®è·µé…ç½®ä¸‹æ¥ï¼Œå‘ç°å¾ˆå¤šé…ç½®å¹¶ä¸èƒ½å·¥ä½œï¼Œé‚£äº›æ»¡è¶³éœ€æ±‚çš„é…ç½®å´ä¼šå¯¼è‡´å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªå…³äºå®‰å…¨æ–¹é¢çš„é—®é¢˜ï¼é‚£å°±æ˜¯å¯¹äºå†…ç½‘æœåŠ¡å™¨æ¥è¯´ï¼Œæ‰€æœ‰çš„è®¿é—®éƒ½ä¼šæ˜¯æ˜¾ç¤ºæ¥è‡ªäºä½ çš„å…¬ç½‘IPï¼Œåº”ç”¨æœåŠ¡çš„è®¿é—®æ—¥å¿—é‡Œæ²¡æœ‰æ­£ç¡®çš„è®¿é—®è€…IPï¼Œæ‰€æœ‰è®¿é—®éƒ½æ˜¾ç¤ºæ¥è‡ªä½ çš„å…¬ç½‘IPã€‚

è¿™ä¸€ç‚¹å…¶å®æˆ‘åœ¨ä¸Šä¸ªè·¯ç”±å™¨å°±å‘ç°äº†ï¼Œåœ¨æˆ‘æ›´æ¢äº†æ–°è·¯ç”±å™¨å†é…ç½®ç›¸åŒçš„åŠŸèƒ½æ—¶ï¼Œè¿™ä¸ªé—®é¢˜ä¾æ—§è¿˜åœ¨ã€‚æ‰€ä»¥æˆ‘å†³å®šä¸åœ¨è·¯ç”±å™¨ä¸Šé…ç½®æ­¤åŠŸèƒ½äº†ï¼Œè€Œä¸”æˆ‘æœ¬èº«åœ¨æœ¬åœ°å°±å·²æœ‰DNSæœåŠ¡ï¼Œé‚è®¾ç½®è®¿é—®æŒ‡å®šåŸŸåç›´æ¥ç”¨æœ¬åœ°DNSè§£æåˆ°å†…ç½‘æœåŠ¡å™¨å³å¯ã€‚

* * *

åŸæœ‰çš„è·¯ç”±å™¨æ¯éš”ä¸€æ®µæ—¶é—´å°±å‘ç”Ÿç½‘ç»œæ•…éšœï¼Œä½†æˆ‘åˆæ‰¾ä¸åˆ°å¯¼è‡´æ•…éšœçš„åŸå› æ›´æ— æ³•è§£å†³ï¼Œåªèƒ½é é‡å¯å¤§æ³•è§£å†³ã€‚æœ€ç»ˆé€‰æ‹©äº† [Mikrotik RB750Gr3](https://mikrotik.com/product/RB750Gr3) è¿™æ¬¾5å£æœ‰çº¿è·¯ç”±å™¨ï¼Œä¹Ÿå°±ç”¨ä¸Šäº† RouterOSã€‚ï¼ˆå½“ç„¶ä½ å«Œæ­¤æ¬¾è·¯ç”±å™¨çš„ä»·æ ¼ä¹Ÿæœ‰ä¾¿å®œçš„æ–¹æ³•[^1][^2]ï¼‰

æ¥ä¸‹æ¥å°±è¦æŠŠ[ä¹‹å‰è·¯ç”±å™¨çš„é…ç½®](https://blog.xavierskip.com/2023-02-19-nat-config/)åœ¨æ­¤æ¬¾è·¯ç”±å™¨ä¸Šä¹Ÿé…ç½®ä¸€éã€‚

åŒæ ·ï¼Œé…ç½®å‰ä¸€æ¬¾è·¯ç”±å™¨é‡åˆ°çš„é—®é¢˜ï¼Œåœ¨æ­¤æ¬¾è·¯ç”±å™¨ä¹Ÿé‡åˆ°äº†ã€‚

é—®é¢˜å°±æ˜¯ï¼Œç«¯å£æ˜ å°„åˆ°å…¬ç½‘çš„ç«¯å£ï¼Œå¦‚ä½•é…ç½®è®©å†…ç½‘ç”¨æˆ·å’Œå¤–ç½‘ç”¨æˆ·ç”¨æˆ·é€šè¿‡åŒæ ·çš„IPåœ°å€æ¥è®¿é—®ï¼Ÿ

å½¢è±¡çš„è¯´æ˜çš„å°±æ˜¯ï¼Œä½ çš„å…¬ç½‘IPæ˜¯ 5.5.5.5ï¼Œé€šè¿‡ ddns ç»‘å®šçš„åŸŸåæ˜¯ home.netï¼Œä½ éœ€è¦å°†å†…ç½‘æœåŠ¡å™¨ 192.168.1.10  7777 ç«¯å£ä¸Šçš„æœåŠ¡æ˜ å°„åˆ°å…¬ç½‘ä¸Šï¼Œåœ¨å…¬ç½‘ä¸Šå¯ä»¥é€šè¿‡ home.net:7777 åœ°å€æ¥è®¿é—®ï¼ŒåŒæ—¶ä½ ä¹Ÿæƒ³è®©å†…ç½‘ç”¨æˆ·é€šè¿‡åŒæ ·çš„åŸŸååœ°å€æ¥è®¿é—®è¿™ä¸ªæœåŠ¡ã€‚

ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºä¸€èˆ¬è¿™ç§å¯¹å…¬ç½‘æä¾›æœåŠ¡æˆ‘ä»¬éƒ½æ˜¯é€šè¿‡åŸŸåçš„å½¢å¼æ¥è®¿é—®çš„ï¼Œæ¯•ç«Ÿå®½å¸¦ä¸æ˜¯å›ºå®šIPã€‚ 

ä½ ä¼šå‘ç°ä»…ä»…é€šè¿‡è®¾ç½®`ç›®çš„åœ°å€è½¬æ¢ dst-nat`åªèƒ½æ»¡è¶³å¤–ç½‘ç”¨æˆ·çš„è®¿é—®ï¼Œå†…ç½‘ç”¨æˆ·æ˜¯ä¸èƒ½é€šè¿‡å¤–ç½‘åœ°å€åŠæ˜ å°„çš„ç«¯å£æ¥è®¿é—®å†…éƒ¨æœåŠ¡çš„ã€‚å½“ç„¶ç½‘ç»œä¸Šæœ‰å„ç§æ–¹æ³•æ¥æ•™ä½ å¦‚ä½•é…ç½®[^3]ï¼Œä½†æ˜¯æœ€åæˆ‘æ”¾å¼ƒäº†è¿™æ ·çš„å°è¯•ã€‚

ä¸ºä»€ä¹ˆå†…ç½‘ç”¨æˆ·ä¸èƒ½ç”¨å…¬ç½‘åœ°å€è®¿é—®æ˜ å°„åˆ°å…¬ç½‘çš„æœåŠ¡å‘¢ï¼Ÿ

```
# https://asciiflow.com/

              [request]                                                    
             src-ip:192.168.1.100                                          
             src-port:5656                                                 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  dst-ip:5.5.5.5                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   
â”‚         â”‚  dst-port:7777                 â”‚         â”‚                   
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”€â”¤         â”‚                   
â”‚  user   â”‚                                â”‚  route  â”‚                   
â”‚         â”‚                                â”‚         â”‚                   
â”‚         â”‚                                â”‚         â”‚                   
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                   
     â–²                                          â”‚      [request]         
     â”‚   [response]                             â”‚ src-ip:192.168.1.100   
     â”‚ src-ip:192.168.1.2                       â”‚ src-port:5656          
     â”‚ src-port:7777                            â”‚ dst-ip:192.168.1.2     
     â”‚ dst-ip:192.168.1.100                     â”‚ dst-port:7777          
     â”‚ dst-port:5656                            â”‚                        
     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚                        
     â”‚              â”‚          â”‚                â”‚                        
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  server  â”œâ—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        
                    â”‚          â”‚                                           
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           
```

å½“ä½ çš„pcå‘å‡ºçš„æ•°æ®åŒ…ï¼š`192.168.1.100:5656 -> 5.5.5.5:7777`ï¼Œé‚£ä¹ˆä½ çš„ pc å¯¹äºæ¥å—åˆ°çš„æ•°æ®åŒ…ä¸ç¬¦åˆ `5.5.5.5:7777 -> 192.168.1.100:5656`çš„å°†ä¼šä¸¢å¼ƒ[^4][^5]ã€‚

å¦‚æœæƒ³æ¥æ”¶åˆ°æ•°æ®åŒ…ï¼Œé‚£éœ€è¦åšæºåœ°å€è½¬æ¢ï¼ŒæœåŠ¡å™¨ä¸å†å°†æ•°æ®ç›´æ¥è¿”å›ç»™å†…ç½‘è®¿é—®è€…ï¼Œè€Œæ˜¯äº¤ç»™è·¯ç”±å™¨ï¼Œç»è¿‡è·¯ç”±å™¨è½¬æ¢åå†äº¤ç»™å†…ç½‘è®¿é—®è€…ã€‚è¿™æ ·çš„è¯ï¼Œç»è¿‡æºåœ°å€è½¬æ¢çš„æ•°æ®åŒ…åœ¨æœåŠ¡ç«¯çœ‹æ¥éƒ½æ¥è‡ªåŒä¸€IPï¼Œä¹Ÿä¹Ÿå¼•èµ·ä¸Šé¢æåˆ°çš„å®‰å…¨é—®é¢˜ï¼Œä¸èƒ½é€šè¿‡æºåœ°å€IPæ¥è¾¨åˆ«è®¿é—®è€…ã€‚

å¦‚æœä½ æ²¡æœ‰è¿™æ–¹é¢çš„éœ€æ±‚å’Œæ‹…å¿ƒï¼Œé‚£ä¹ˆç¡®å®æœ‰ç›¸åº”çš„è§£å†³æ–¹æ¡ˆï¼Œåœ¨ RouterOS ä¸­åè¯å«åš [Hairpin NAT](https://help.mikrotik.com/docs/spaces/ROS/pages/3211299/NAT#NAT-HairpinNAT)[^6] [^7]

```
;;; ç›®çš„åœ°å€è½¬æ¢
/ip firewall nat add chain=dstnat action=dst-nat to-addresses=192.168.1.2 to-ports=7777 protocol=tcp dst-port=7777,7788 

;;; æºåœ°å€è½¬æ¢
/ip firewall nat add chain=srcnat action=masquerade protocol=tcp src-address=192.168.1.0/24 dst-address=192.168.1.2 out-interface-list=LAN
```

ä¸Šé¢ä¸¤æ¡è§„åˆ™é…åˆæ‰èƒ½ç”Ÿæ•ˆï¼Œå¯¹äºå¤–éƒ¨è®¿é—®ï¼Œæºåœ°å€ipå¾—ä»¥ä¿ç•™ï¼Œå¯¹äºå†…éƒ¨è®¿é—®ï¼Œæ‰€æœ‰çš„æºåœ°å€ipéƒ½ä¸ºè·¯ç”±å™¨åœ°å€`192.168.1.1`ã€‚

å¯¹äº iptables é˜²ç«å¢™çš„å·¥ä½œæµç¨‹ï¼Œä»€ä¹ˆå››è¡¨äº”é“¾çœ‹ç€å°±å¤´å¤§ï¼Œå®Œå…¨æ²¡æœ‰å®é™…çš„è®¤çŸ¥ï¼Œ[Packet Flow in RouterOS](https://help.mikrotik.com/docs/spaces/ROS/pages/328227/Packet+Flow+in+RouterOS) ğŸ˜µğŸ˜µğŸ˜µ


[^1]:[ä¸åˆ°50å…ƒä¸Šæ‰‹RouterOSåƒå…†RB750Gr3è·¯ç”±å™¨](https://huwencai.com/2023/03/bu-dao-yuan-shang-shou-routeros-qian-zhao-rbgr-lu-you-qi/)
[^2]:[å‹åwr330ç›´æ¥åˆ·æˆmikrotik rb750gr3](https://www.right.com.cn/forum/thread-5303754-1-1.html)
[^3]:[å…¬ç½‘ IP çš„æœåŠ¡ï¼Œåªèƒ½ä»ã€Œéæœ¬æœºåœ°å€ã€è®¿é—®ï¼Œæ±‚è§£](https://v2ex.com/t/936873)
[^4]:[å°ç™½å¯¹OpenWrté˜²ç«å¢™IPv4 NATç¯å› (NAT Loopback) çš„ä¸€ç‚¹ç ”ç©¶ç†è§£](https://www.right.com.cn/forum/thread-8203412-1-1.html)
[^5]:[ç”¨RouterOSåšç«¯å£æ˜ å°„æ—¶é‡åˆ°çš„å›æµé—®é¢˜](https://huwencai.com/2023/04/yong-routeros-zuo-duan-kou-ying-she-shi-yu-dao-de-hui-liu/)
[^6]:[MikroTik RouterOS 7 å›æµå•é¡Œè§£æ±ºæ–¹æ¡ˆ](https://kingtam.win/archives/hairpin.html)
[^7]:[RouterOS çš„Hairpin é…ç½®](https://archive.ph/caogy)


